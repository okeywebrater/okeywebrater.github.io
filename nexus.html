<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus | Private Messenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root { --accent: #3b82f6; --bg: #0b0e11; --panel: #111b21; }
        body.light-theme { --accent: #2563eb; --bg: #f0f2f5; --panel: #ffffff; color: #111; }
        body { background-color: var(--bg); color: #e9edef; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; transition: 0.3s; }
        .glass { background: var(--panel); backdrop-filter: blur(10px); }
        .message-anim { animation: fadeInUp 0.3s ease; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .msg-mine { background: #005c4b; align-self: flex-end; border-radius: 12px 0 12px 12px; }
        .msg-their { background: #202c33; align-self: flex-start; border-radius: 0 12px 12px 12px; }
        .light-theme .msg-their { background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="h-screen flex items-center justify-center overflow-hidden">

    <div id="auth-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-[#0b0e11] animate__animated animate__fadeIn">
        <div class="w-full max-w-sm p-10 text-center glass rounded-3xl shadow-2xl">
            <h1 class="text-5xl font-extrabold mb-10 bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent">Nexus</h1>
            <input id="username" type="text" placeholder="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–∏–∫" class="w-full bg-white/5 p-4 rounded-xl mb-4 outline-none border border-white/10 focus:border-blue-500 transition-all text-center text-xl">
            <button id="login-btn" class="w-full bg-blue-600 p-4 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-600/30 active:scale-95 transition-all">–í–æ–π—Ç–∏</button>
        </div>
    </div>

    <div id="app" class="hidden w-full h-full flex animate__animated animate__fadeIn">
        <aside class="w-80 border-r border-white/5 flex flex-col glass">
            <div class="p-4 flex justify-between items-center border-b border-white/5">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center font-bold" id="my-avatar">?</div>
                    <span id="my-name" class="font-bold truncate w-24"></span>
                </div>
                <button onclick="toggleSettings()" class="p-2 hover:bg-white/5 rounded-full transition">‚öôÔ∏è</button>
            </div>
            
            <div class="p-4">
                <input id="user-search" oninput="filterLocalUsers()" type="text" placeholder="–ü–æ–∏—Å–∫ –≤ –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö..." class="w-full bg-white/5 p-2 rounded-lg outline-none text-sm">
            </div>

            <div id="contacts" class="flex-1 overflow-y-auto custom-scroll">
                </div>
            
            <button onclick="addNewContact()" class="m-4 p-3 bg-blue-600/20 text-blue-400 rounded-xl font-semibold hover:bg-blue-600/30 transition">+ –ù–∞–π—Ç–∏ –Ω–æ–≤–æ–≥–æ —é–∑–µ—Ä–∞</button>
        </aside>

        <main class="flex-1 flex flex-col relative bg-[#0b0e11]">
            <header id="chat-header" class="p-4 glass flex justify-between items-center z-10 hidden">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-blue-500 to-emerald-500"></div>
                    <span id="active-user" class="font-bold text-lg"></span>
                </div>
                <div class="flex gap-4 items-center">
                    <button onclick="startCall('audio')" class="p-2 hover:bg-green-500/20 rounded-full text-green-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                    </button>
                </div>
            </header>

            <div id="messages" class="flex-1 overflow-y-auto p-6 flex flex-col gap-3">
                </div>

            <div class="p-4 glass">
                <div class="flex gap-3 items-center max-w-4xl mx-auto">
                    <label class="cursor-pointer p-2 hover:bg-white/5 rounded-full transition">
                        üì∑ <input type="file" id="photo-input" class="hidden" accept="image/*" onchange="sendPhoto(this)">
                    </label>
                    <input id="msg-input" type="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." class="flex-1 bg-white/5 p-3 rounded-2xl outline-none focus:ring-1 ring-blue-500">
                    <button id="send-btn" class="bg-blue-600 p-3 rounded-2xl shadow-lg shadow-blue-600/20 hover:scale-105 transition active:scale-95">‚û§</button>
                </div>
            </div>

            <div id="call-screen" class="hidden fixed inset-0 z-[110] bg-black/95 flex flex-col items-center justify-center animate__animated animate__fadeIn">
                <div class="w-32 h-32 rounded-full bg-blue-600 animate-pulse flex items-center justify-center text-4xl mb-6" id="call-icon">üë§</div>
                <h2 id="call-title" class="text-2xl font-bold mb-10">–í—ã–∑–æ–≤...</h2>
                <audio id="remote-audio" autoplay></audio>
                <button onclick="endCall()" class="bg-red-500 p-6 rounded-full shadow-2xl shadow-red-500/40">‚úñ</button>
            </div>
        </aside>
    </div>

    <div id="settings-modal" class="hidden fixed inset-0 z-[120] flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="w-80 p-6 glass rounded-3xl animate__animated animate__zoomIn">
            <h2 class="text-xl font-bold mb-6">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <button onclick="toggleTheme()" class="w-full p-3 bg-white/5 rounded-xl mb-3 hover:bg-white/10 transition">–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É üåó</button>
            <button onclick="toggleSettings()" class="w-full p-3 bg-blue-600 rounded-xl font-bold">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBCCMox8AjDNFcsqDvrrSD_uBofbCcvZJY",
            authDomain: "nexuschat-84243.firebaseapp.com",
            projectId: "nexuschat-84243",
            storageBucket: "nexuschat-84243.firebasestorage.app",
            messagingSenderId: "145066619214",
            appId: "1:145066619214:web:81f1608426e58bddfaae1f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        let peer, myNick, targetNick, localStream;

        // –ó–ê–ü–†–ï–¢ –ú–£–õ–¨–¢–ò-–í–•–û–î–ê –í –û–î–ù–û–ú –ë–†–ê–£–ó–ï–†–ï (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏)
        if (sessionStorage.getItem('nexus_active')) {
            alert("Nexus —É–∂–µ –∑–∞–ø—É—â–µ–Ω –≤ —ç—Ç–æ–π –≤–∫–ª–∞–¥–∫–µ!");
            // window.location.href = "about:blank"; // –ú–æ–∂–Ω–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –∂–µ—Å—Ç–∫–æ–≥–æ –∑–∞–ø—Ä–µ—Ç–∞
        }

        // –í–•–û–î
        document.getElementById('login-btn').onclick = async () => {
            const user = document.getElementById('username').value.trim().toLowerCase();
            if(user.length < 2) return;

            const userRef = doc(db, "users", user);
            const userSnap = await getDoc(userRef);

            if(userSnap.exists() && !sessionStorage.getItem('is_relog')) {
                // –ï—Å–ª–∏ —é–∑–µ—Ä –µ—Å—Ç—å, –∞ —Å–µ—Å—Å–∏–∏ –Ω–µ—Ç - –∑–Ω–∞—á–∏—Ç –∫—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–π
                // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –≤ —ç—Ç–æ–º –∫–æ–¥–µ –º—ã –ø—Ä–æ—Å—Ç–æ —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤—Ö–æ–¥, –Ω–æ –º–µ—Ç–∏–º —Å–µ—Å—Å–∏—é
            }

            myNick = user;
            sessionStorage.setItem('nexus_active', 'true');
            document.getElementById('my-name').innerText = user;
            document.getElementById('my-avatar').innerText = user[0].toUpperCase();
            document.getElementById('auth-screen').classList.add('animate__fadeOut');
            setTimeout(() => {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
            }, 500);

            Notification.requestPermission();
            initPeer();
        };

        // –ü–ï–†–°–û–ù–ê–õ–ò–ó–ê–¶–ò–Ø –ò –¢–ï–ú–ê
        window.toggleTheme = () => document.body.classList.toggle('light-theme');
        window.toggleSettings = () => document.getElementById('settings-modal').classList.toggle('hidden');

        // –ü–û–ò–°–ö
        window.addNewContact = async () => {
            const search = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ —é–∑–µ—Ä–∞:").toLowerCase();
            if(!search || search === myNick) return;
            const snap = await getDoc(doc(db, "users", search));
            if(snap.exists()) renderContact(search);
            else alert("–Æ–∑–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");
        };

        function renderContact(user) {
            const id = `c-${user}`;
            if(document.getElementById(id)) return;
            const html = `
                <div id="${id}" onclick="openChat('${user}')" class="p-4 flex items-center gap-3 cursor-pointer hover:bg-white/5 transition border-l-4 border-transparent">
                    <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center uppercase">${user[0]}</div>
                    <span class="font-medium">${user}</span>
                </div>
            `;
            document.getElementById('contacts').insertAdjacentHTML('beforeend', html);
        }

        window.filterLocalUsers = () => {
            const val = document.getElementById('user-search').value.toLowerCase();
            document.querySelectorAll('#contacts > div').forEach(el => {
                el.style.display = el.innerText.toLowerCase().includes(val) ? 'flex' : 'none';
            });
        };

        // –ß–ê–¢
        window.openChat = (user) => {
            targetNick = user;
            document.getElementById('chat-header').classList.remove('hidden');
            document.getElementById('chat-header').classList.add('flex');
            document.getElementById('active-user').innerText = user;
            document.querySelectorAll('#contacts > div').forEach(el => el.classList.remove('bg-blue-600/10', 'border-blue-500'));
            document.getElementById(`c-${user}`).classList.add('bg-blue-600/10', 'border-blue-500');
            loadMessages();
        };

        // –°–û–û–ë–©–ï–ù–ò–Ø –ò –§–û–¢–û
        document.getElementById('send-btn').onclick = () => sendMessage();
        document.getElementById('msg-input').onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };

        async function sendMessage(fileUrl = null) {
            const input = document.getElementById('msg-input');
            if(!fileUrl && !input.value) return;

            await addDoc(collection(db, "messages"), {
                from: myNick, to: targetNick,
                text: input.value || "",
                image: fileUrl,
                time: serverTimestamp()
            });
            input.value = "";
        }

        window.sendPhoto = async (input) => {
            if(!input.files[0]) return;
            const file = input.files[0];
            const storageRef = ref(storage, `chats/${Date.now()}_${file.name}`);
            const upload = await uploadBytes(storageRef, file);
            const url = await getDownloadURL(upload.ref);
            sendMessage(url);
        };

        function loadMessages() {
            const q = query(collection(db, "messages"), orderBy("time", "asc"));
            onSnapshot(q, (snap) => {
                const box = document.getElementById('messages');
                box.innerHTML = "";
                snap.forEach(d => {
                    const m = d.data();
                    if((m.from === myNick && m.to === targetNick) || (m.from === targetNick && m.to === myNick)) {
                        const isMine = m.from === myNick;
                        const div = document.createElement('div');
                        div.className = `p-3 px-4 max-w-[75%] message-anim ${isMine ? 'msg-mine' : 'msg-their'}`;
                        
                        if(m.image) div.innerHTML += `<img src="${m.image}" class="rounded-lg mb-2 max-h-60 w-full object-cover">`;
                        if(m.text) div.innerHTML += `<div>${m.text}</div>`;
                        
                        box.appendChild(div);

                        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                        if(!isMine && m.from === targetNick && document.hidden) {
                            new Notification(`Nexus: ${m.from}`, { body: m.text });
                        }
                    }
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        // –ó–í–û–ù–ö–ò (PeerJS)
        function initPeer() {
            peer = new Peer(myNick);
            peer.on('call', async (call) => {
                if(confirm("–í—Ö–æ–¥—è—â–∏–π –∞—É–¥–∏–æ–∑–≤–æ–Ω–æ–∫ –æ—Ç " + call.peer)) {
                    const stream = await navigator.mediaDevices.getUserMedia({audio: true});
                    call.answer(stream);
                    showCallUI(call.peer);
                    call.on('stream', (rStream) => {
                        document.getElementById('remote-audio').srcObject = rStream;
                    });
                }
            });
        }

        window.startCall = async () => {
            showCallUI(targetNick);
            const stream = await navigator.mediaDevices.getUserMedia({audio: true});
            localStream = stream;
            const call = peer.call(targetNick, stream);
            call.on('stream', (rStream) => {
                document.getElementById('remote-audio').srcObject = rStream;
            });
        };

        function showCallUI(name) {
            document.getElementById('call-screen').classList.remove('hidden');
            document.getElementById('call-title').innerText = name;
        }

        window.endCall = () => {
            location.reload(); 
        };
    </script>
</body>
</html>
